// Monitrax Database Schema
// This is the single source of truth for all financial data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum PropertyType {
  HOME
  INVESTMENT
}

enum LoanType {
  HOME
  INVESTMENT
}

enum RateType {
  VARIABLE
  FIXED
}

enum RepaymentFrequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
}

enum AccountType {
  OFFSET
  SAVINGS
  TRANSACTIONAL
  CREDIT_CARD
}

enum IncomeType {
  SALARY
  RENT
  RENTAL
  INVESTMENT
  OTHER
}

enum ExpenseCategory {
  HOUSING
  RATES
  INSURANCE
  MAINTENANCE
  PERSONAL
  UTILITIES
  FOOD
  TRANSPORT
  ENTERTAINMENT
  STRATA
  LAND_TAX
  LOAN_INTEREST
  OTHER
}

enum Frequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
  ANNUAL
}

enum TransactionDirection {
  IN
  OUT
}

enum UserRole {
  OWNER       // Full permissions, billing, member management
  ADMIN       // Manage users and data, no billing/org deletion
  CONTRIBUTOR // Full access to financial entities, no user management
  VIEWER      // Read-only access

  // Legacy roles - kept for backward compatibility during migration
  PARTNER     // @deprecated - use CONTRIBUTOR instead
  ACCOUNTANT  // @deprecated - use VIEWER instead
}

enum DebtStrategy {
  TAX_AWARE_MINIMUM_INTEREST
  AVALANCHE
  SNOWBALL
}

// =============================================================================
// PHASE 5: SOURCE TYPE ENUMS
// =============================================================================

enum IncomeSourceType {
  GENERAL
  PROPERTY
  INVESTMENT
}

enum ExpenseSourceType {
  GENERAL
  PROPERTY
  LOAN
  INVESTMENT
}

// =============================================================================
// PHASE 10: AUTH & SECURITY ENUMS
// =============================================================================

enum MFAType {
  TOTP        // Google Authenticator, Authy
  SMS         // SMS fallback
  WEBAUTHN    // FIDO2, Passkeys, hardware keys
}

enum AuditAction {
  // Auth
  LOGIN
  LOGOUT
  MFA_CHALLENGE
  MFA_SUCCESS
  MFA_FAILURE
  PASSWORD_CHANGE
  PASSWORD_RESET

  // Passkey / WebAuthn
  PASSKEY_REGISTER
  PASSKEY_UPDATE
  PASSKEY_DELETE

  // CRUD operations
  CREATE
  READ
  UPDATE
  DELETE

  // Special operations
  EXPORT
  BULK_DELETE

  // Admin operations
  ROLE_CHANGE
  ORG_MEMBER_ADD
  ORG_MEMBER_REMOVE
  ORG_SETTINGS_UPDATE
  SESSION_REVOKE
  ACCOUNT_LOCK
  ACCOUNT_UNLOCK
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED

  // Security
  RATE_LIMIT_HIT
  UNAUTHORIZED_ACCESS
  FORBIDDEN_ACCESS
}

enum AuditStatus {
  SUCCESS
  FAILURE
  BLOCKED
}

// =============================================================================
// USER
// =============================================================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String?   // Nullable for passwordless accounts
  name              String
  role              UserRole  @default(OWNER)
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  mfaEnabled        Boolean   @default(false)
  mfaEnforcedByOrg  Boolean   @default(false)
  accountLocked     Boolean   @default(false)
  accountLockedUntil DateTime?
  lastLoginAt       DateTime?
  lastLoginIp       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  properties          Property[]
  loans               Loan[]
  accounts            Account[]
  income              Income[]
  expenses            Expense[]
  transactions        Transaction[]
  debtPlans           DebtPlan[]
  investmentAccounts  InvestmentAccount[]

  // Phase 10: Auth & Security
  organizationMemberships OrganizationMember[]
  mfaMethods              MFAMethod[]
  sessions                UserSession[]
  auditLogs               AuditLog[]
  passkeyCredentials      PasskeyCredential[]
  magicLinks              MagicLink[]
  oauthAccounts           OAuthAccount[]
  loginAttempts           LoginAttempt[]
  emailMFACodes           EmailMFACode[]

  @@map("users")
}

// =============================================================================
// PROPERTY
// =============================================================================

model Property {
  id             String       @id @default(uuid())
  userId         String
  name           String
  type           PropertyType
  address        String?
  purchasePrice  Float
  purchaseDate   DateTime
  currentValue   Float
  valuationDate  DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relationships
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  loans                 Loan[]
  income                Income[]
  expenses              Expense[]
  depreciationSchedules DepreciationSchedule[]

  @@index([userId])
  @@map("properties")
}

// =============================================================================
// LOAN
// =============================================================================

model Loan {
  id                   String              @id @default(uuid())
  userId               String
  propertyId           String?
  offsetAccountId      String?             @unique
  name                 String
  type                 LoanType
  principal            Float               // Current balance
  interestRateAnnual   Float               // e.g., 0.0625 for 6.25%
  rateType             RateType
  fixedExpiry          DateTime?           // When fixed rate expires
  isInterestOnly       Boolean             @default(false)
  termMonthsRemaining  Int
  minRepayment         Float               // Current required payment
  repaymentFrequency   RepaymentFrequency
  extraRepaymentCap    Float?              // Annual cap for extra repayments on fixed loans
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Relationships
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  property       Property?    @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  offsetAccount  Account?     @relation(fields: [offsetAccountId], references: [id], onDelete: SetNull)
  expenses       Expense[]
  debtPlanLoans  DebtPlanLoan[]

  @@index([userId])
  @@index([propertyId])
  @@map("loans")
}

// =============================================================================
// ACCOUNT
// =============================================================================

model Account {
  id             String       @id @default(uuid())
  userId         String
  name           String
  type           AccountType
  institution    String?
  currentBalance Float
  interestRate   Float?       // Annual interest rate (e.g., 0.025 for 2.5%)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relationships
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  linkedLoan   Loan?         // One-to-one: this account can be an offset for one loan

  @@index([userId])
  @@map("accounts")
}

// =============================================================================
// INCOME
// =============================================================================

model Income {
  id                    String            @id @default(uuid())
  userId                String
  propertyId            String?
  investmentAccountId   String?
  name                  String
  type                  IncomeType
  sourceType            IncomeSourceType  @default(GENERAL)
  amount                Float
  frequency             Frequency
  isTaxable             Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relationships
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  property          Property?          @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  investmentAccount InvestmentAccount? @relation(fields: [investmentAccountId], references: [id], onDelete: SetNull)
  transactions      Transaction[]

  @@index([userId])
  @@index([propertyId])
  @@index([investmentAccountId])
  @@map("income")
}

// =============================================================================
// EXPENSE
// =============================================================================

model Expense {
  id                    String             @id @default(uuid())
  userId                String
  propertyId            String?
  loanId                String?
  investmentAccountId   String?
  name                  String
  vendorName            String?
  category              ExpenseCategory
  sourceType            ExpenseSourceType  @default(GENERAL)
  amount                Float
  frequency             Frequency
  isEssential           Boolean            @default(true)
  isTaxDeductible       Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relationships
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  property          Property?          @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  loan              Loan?              @relation(fields: [loanId], references: [id], onDelete: SetNull)
  investmentAccount InvestmentAccount? @relation(fields: [investmentAccountId], references: [id], onDelete: SetNull)
  transactions      Transaction[]

  @@index([userId])
  @@index([propertyId])
  @@index([loanId])
  @@index([investmentAccountId])
  @@map("expenses")
}

// =============================================================================
// TRANSACTION
// =============================================================================

model Transaction {
  id          String               @id @default(uuid())
  userId      String
  accountId   String
  propertyId  String?
  loanId      String?
  incomeId    String?
  expenseId   String?
  date        DateTime
  description String
  amount      Float
  direction   TransactionDirection
  category    String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  // Relationships
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  income   Income?   @relation(fields: [incomeId], references: [id], onDelete: SetNull)
  expense  Expense?  @relation(fields: [expenseId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([accountId])
  @@index([date])
  @@map("transactions")
}

// =============================================================================
// DEBT PLAN (Optional storage of debt planner results)
// =============================================================================

model DebtPlan {
  id                    String        @id @default(uuid())
  userId                String
  name                  String
  strategy              DebtStrategy
  surplusPerPeriod      Float
  surplusFrequency      Frequency
  emergencyBuffer       Float         @default(0)
  respectFixedCaps      Boolean       @default(true)
  rolloverRepayments    Boolean       @default(true)
  totalInterestPaid     Float
  totalInterestSaved    Float
  debtFreeDate          DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relationships
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  loanDetails DebtPlanLoan[]

  @@index([userId])
  @@map("debt_plans")
}

// =============================================================================
// DEBT PLAN LOAN (Per-loan results from debt planner)
// =============================================================================

model DebtPlanLoan {
  id                String    @id @default(uuid())
  debtPlanId        String
  loanId            String
  loanName          String
  originalPrincipal Float
  payoffDate        DateTime
  totalInterestPaid Float
  monthsSaved       Int
  interestSaved     Float
  createdAt         DateTime  @default(now())

  // Relationships
  debtPlan DebtPlan @relation(fields: [debtPlanId], references: [id], onDelete: Cascade)
  loan     Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([debtPlanId])
  @@index([loanId])
  @@map("debt_plan_loans")
}

// =============================================================================
// PHASE 3: INVESTMENT ENUMS
// =============================================================================

enum InvestmentAccountType {
  BROKERAGE
  SUPERS
  FUND
  TRUST
  ETF_CRYPTO
}

enum HoldingType {
  SHARE
  ETF
  MANAGED_FUND
  CRYPTO
}

enum InvestmentTransactionType {
  BUY
  SELL
  DIVIDEND
  DISTRIBUTION
  DRP
}

enum DepreciationCategory {
  DIV40
  DIV43
}

enum DepreciationMethod {
  PRIME_COST
  DIMINISHING_VALUE
}

// =============================================================================
// PHASE 3: INVESTMENT ACCOUNT
// =============================================================================

model InvestmentAccount {
  id           String                @id @default(uuid())
  userId       String
  name         String
  type         InvestmentAccountType
  platform     String?               // e.g. CommSec, SelfWealth, Betashares app
  currency     String                @default("AUD")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  // Relationships
  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings     InvestmentHolding[]
  transactions InvestmentTransaction[]
  incomes      Income[]
  expenses     Expense[]

  @@index([userId])
  @@map("investment_accounts")
}

// =============================================================================
// PHASE 3: INVESTMENT HOLDING
// =============================================================================

model InvestmentHolding {
  id                  String            @id @default(uuid())
  investmentAccountId String
  ticker              String            // VAS, A200, VGS, BHP
  units               Float
  averagePrice        Float
  frankingPercentage  Float?            // AU feature for franking credits
  type                HoldingType
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relationships
  investmentAccount   InvestmentAccount       @relation(fields: [investmentAccountId], references: [id], onDelete: Cascade)
  transactions        InvestmentTransaction[]

  @@index([investmentAccountId])
  @@map("investment_holdings")
}

// =============================================================================
// PHASE 3: INVESTMENT TRANSACTION
// =============================================================================

model InvestmentTransaction {
  id                  String                    @id @default(uuid())
  investmentAccountId String
  holdingId           String?
  date                DateTime
  type                InvestmentTransactionType
  price               Float
  units               Float
  fees                Float?
  notes               String?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt

  // Relationships
  investmentAccount   InvestmentAccount   @relation(fields: [investmentAccountId], references: [id], onDelete: Cascade)
  holding             InvestmentHolding?  @relation(fields: [holdingId], references: [id], onDelete: SetNull)

  @@index([investmentAccountId])
  @@index([holdingId])
  @@map("investment_transactions")
}

// =============================================================================
// PHASE 3: DEPRECIATION SCHEDULE
// =============================================================================

model DepreciationSchedule {
  id         String               @id @default(uuid())
  propertyId String
  category   DepreciationCategory
  assetName  String
  cost       Float
  startDate  DateTime
  rate       Float                // 2.5% for Div43, or effective life rate
  method     DepreciationMethod   // PRIME_COST | DIMINISHING_VALUE
  notes      String?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  // Relationships
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("depreciation_schedules")
}

// =============================================================================
// PHASE 10: ORGANIZATION & MULTI-TENANT
// =============================================================================

model Organization {
  id                    String               @id @default(uuid())
  name                  String
  slug                  String               @unique
  description           String?
  mfaEnforced           Boolean              @default(false)
  sessionDurationHours  Int                  @default(168) // 7 days
  allowedDomains        String[]             // Email domain restrictions
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relationships
  members               OrganizationMember[]
  auditLogs             AuditLog[]

  @@map("organizations")
}

model OrganizationMember {
  id             String        @id @default(uuid())
  organizationId String
  userId         String
  role           UserRole      @default(VIEWER)
  invitedBy      String?       // User ID who sent the invitation
  invitedAt      DateTime      @default(now())
  joinedAt       DateTime?
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relationships
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

// =============================================================================
// PHASE 10: MFA & AUTHENTICATION
// =============================================================================

model MFAMethod {
  id              String    @id @default(uuid())
  userId          String
  type            MFAType
  isEnabled       Boolean   @default(true)
  isPrimary       Boolean   @default(false)
  secret          String?   // For TOTP: encrypted secret
  phoneNumber     String?   // For SMS: phone number
  backupCodes     String[]  // Encrypted backup codes
  lastUsedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("mfa_methods")
}

model PasskeyCredential {
  id                String    @id @default(uuid())
  userId            String
  credentialId      String    @unique // WebAuthn credential ID
  publicKey         String    // Public key for verification
  counter           Int       @default(0)
  deviceName        String?
  transports        String[]  // e.g., ["usb", "nfc", "ble"]
  lastUsedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("passkey_credentials")
}

model UserSession {
  id              String    @id @default(uuid())
  userId          String
  token           String    @unique
  deviceName      String?
  deviceFingerprint String?
  ipAddress       String?
  userAgent       String?
  isActive        Boolean   @default(true)
  expiresAt       DateTime
  lastActivityAt  DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}

// =============================================================================
// PHASE 10: AUDIT LOGGING
// =============================================================================

model AuditLog {
  id              String         @id @default(uuid())
  userId          String?
  organizationId  String?
  action          AuditAction
  status          AuditStatus    @default(SUCCESS)
  entityType      String?        // "Property", "Loan", "User", etc.
  entityId        String?        // ID of the affected entity
  ipAddress       String?
  userAgent       String?
  metadata        Json?          // Additional context (old/new values, error details)
  createdAt       DateTime       @default(now())

  // Relationships
  user            User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization    Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// =============================================================================
// PHASE 10: MAGIC LINK AUTHENTICATION
// =============================================================================

model MagicLink {
  id          String    @id @default(uuid())
  userId      String
  token       String    @unique
  email       String
  expiresAt   DateTime
  usedAt      DateTime?
  redirectTo  String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())

  // Relationships
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("magic_links")
}

// =============================================================================
// PHASE 10: OAUTH ACCOUNTS
// =============================================================================

model OAuthAccount {
  id              String    @id @default(uuid())
  userId          String
  provider        String    // google, apple, microsoft
  providerUserId  String    // ID from OAuth provider
  email           String?
  accessToken     String?   @db.Text
  refreshToken    String?   @db.Text
  expiresAt       DateTime?
  scope           String?
  tokenType       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@map("oauth_accounts")
}
// =============================================================================
// PHASE 10: LOGIN ATTEMPTS (for account lockout)
// =============================================================================

model LoginAttempt {
  id          String    @id @default(uuid())
  userId      String
  email       String
  success     Boolean
  ipAddress   String?
  userAgent   String?
  attemptedAt DateTime  @default(now())

  // Relationships
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([attemptedAt])
  @@map("login_attempts")
}

// =============================================================================
// PHASE 10: EMAIL MFA CODES
// =============================================================================

model EmailMFACode {
  id          String    @id @default(uuid())
  userId      String
  code        String    // SHA-256 hashed
  expiresAt   DateTime
  verified    Boolean   @default(false)
  verifiedAt  DateTime?
  attempts    Int       @default(0)
  createdAt   DateTime  @default(now())

  // Relationships
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
  @@map("email_mfa_codes")
}
