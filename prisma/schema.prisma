// Monitrax Database Schema
// This is the single source of truth for all financial data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum PropertyType {
  HOME
  INVESTMENT
}

enum LoanType {
  HOME
  INVESTMENT
}

enum RateType {
  VARIABLE
  FIXED
}

enum RepaymentFrequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
}

enum AccountType {
  OFFSET
  SAVINGS
  TRANSACTIONAL
  CREDIT_CARD
}

enum IncomeType {
  SALARY
  RENT
  RENTAL
  INVESTMENT
  OTHER
}

enum ExpenseCategory {
  HOUSING
  RATES
  INSURANCE
  MAINTENANCE
  PERSONAL
  UTILITIES
  FOOD
  TRANSPORT
  ENTERTAINMENT
  STRATA
  LAND_TAX
  LOAN_INTEREST
  OTHER
}

enum Frequency {
  WEEKLY
  FORTNIGHTLY
  MONTHLY
  ANNUAL
}

enum TransactionDirection {
  IN
  OUT
}

enum UserRole {
  OWNER
  PARTNER
  ACCOUNTANT
}

enum DebtStrategy {
  TAX_AWARE_MINIMUM_INTEREST
  AVALANCHE
  SNOWBALL
}

// =============================================================================
// PHASE 5: SOURCE TYPE ENUMS
// =============================================================================

enum IncomeSourceType {
  GENERAL
  PROPERTY
  INVESTMENT
}

enum ExpenseSourceType {
  GENERAL
  PROPERTY
  LOAN
  INVESTMENT
}

// =============================================================================
// USER
// =============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(OWNER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  properties          Property[]
  loans               Loan[]
  accounts            Account[]
  income              Income[]
  expenses            Expense[]
  transactions        Transaction[]
  debtPlans           DebtPlan[]
  investmentAccounts  InvestmentAccount[]

  @@map("users")
}

// =============================================================================
// PROPERTY
// =============================================================================

model Property {
  id             String       @id @default(uuid())
  userId         String
  name           String
  type           PropertyType
  address        String?
  purchasePrice  Float
  purchaseDate   DateTime
  currentValue   Float
  valuationDate  DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relationships
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  loans                 Loan[]
  income                Income[]
  expenses              Expense[]
  depreciationSchedules DepreciationSchedule[]

  @@index([userId])
  @@map("properties")
}

// =============================================================================
// LOAN
// =============================================================================

model Loan {
  id                   String              @id @default(uuid())
  userId               String
  propertyId           String?
  offsetAccountId      String?             @unique
  name                 String
  type                 LoanType
  principal            Float               // Current balance
  interestRateAnnual   Float               // e.g., 0.0625 for 6.25%
  rateType             RateType
  fixedExpiry          DateTime?           // When fixed rate expires
  isInterestOnly       Boolean             @default(false)
  termMonthsRemaining  Int
  minRepayment         Float               // Current required payment
  repaymentFrequency   RepaymentFrequency
  extraRepaymentCap    Float?              // Annual cap for extra repayments on fixed loans
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Relationships
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  property       Property?    @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  offsetAccount  Account?     @relation(fields: [offsetAccountId], references: [id], onDelete: SetNull)
  expenses       Expense[]
  debtPlanLoans  DebtPlanLoan[]

  @@index([userId])
  @@index([propertyId])
  @@map("loans")
}

// =============================================================================
// ACCOUNT
// =============================================================================

model Account {
  id             String       @id @default(uuid())
  userId         String
  name           String
  type           AccountType
  institution    String?
  currentBalance Float
  interestRate   Float?       // Annual interest rate (e.g., 0.025 for 2.5%)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relationships
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  linkedLoan   Loan?         // One-to-one: this account can be an offset for one loan

  @@index([userId])
  @@map("accounts")
}

// =============================================================================
// INCOME
// =============================================================================

model Income {
  id                    String            @id @default(uuid())
  userId                String
  propertyId            String?
  investmentAccountId   String?
  name                  String
  type                  IncomeType
  sourceType            IncomeSourceType  @default(GENERAL)
  amount                Float
  frequency             Frequency
  isTaxable             Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relationships
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  property          Property?          @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  investmentAccount InvestmentAccount? @relation(fields: [investmentAccountId], references: [id], onDelete: SetNull)
  transactions      Transaction[]

  @@index([userId])
  @@index([propertyId])
  @@index([investmentAccountId])
  @@map("income")
}

// =============================================================================
// EXPENSE
// =============================================================================

model Expense {
  id                    String             @id @default(uuid())
  userId                String
  propertyId            String?
  loanId                String?
  investmentAccountId   String?
  name                  String
  vendorName            String?
  category              ExpenseCategory
  sourceType            ExpenseSourceType  @default(GENERAL)
  amount                Float
  frequency             Frequency
  isEssential           Boolean            @default(true)
  isTaxDeductible       Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relationships
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  property          Property?          @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  loan              Loan?              @relation(fields: [loanId], references: [id], onDelete: SetNull)
  investmentAccount InvestmentAccount? @relation(fields: [investmentAccountId], references: [id], onDelete: SetNull)
  transactions      Transaction[]

  @@index([userId])
  @@index([propertyId])
  @@index([loanId])
  @@index([investmentAccountId])
  @@map("expenses")
}

// =============================================================================
// TRANSACTION
// =============================================================================

model Transaction {
  id          String               @id @default(uuid())
  userId      String
  accountId   String
  propertyId  String?
  loanId      String?
  incomeId    String?
  expenseId   String?
  date        DateTime
  description String
  amount      Float
  direction   TransactionDirection
  category    String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  // Relationships
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  income   Income?   @relation(fields: [incomeId], references: [id], onDelete: SetNull)
  expense  Expense?  @relation(fields: [expenseId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([accountId])
  @@index([date])
  @@map("transactions")
}

// =============================================================================
// DEBT PLAN (Optional storage of debt planner results)
// =============================================================================

model DebtPlan {
  id                    String        @id @default(uuid())
  userId                String
  name                  String
  strategy              DebtStrategy
  surplusPerPeriod      Float
  surplusFrequency      Frequency
  emergencyBuffer       Float         @default(0)
  respectFixedCaps      Boolean       @default(true)
  rolloverRepayments    Boolean       @default(true)
  totalInterestPaid     Float
  totalInterestSaved    Float
  debtFreeDate          DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relationships
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  loanDetails DebtPlanLoan[]

  @@index([userId])
  @@map("debt_plans")
}

// =============================================================================
// DEBT PLAN LOAN (Per-loan results from debt planner)
// =============================================================================

model DebtPlanLoan {
  id                String    @id @default(uuid())
  debtPlanId        String
  loanId            String
  loanName          String
  originalPrincipal Float
  payoffDate        DateTime
  totalInterestPaid Float
  monthsSaved       Int
  interestSaved     Float
  createdAt         DateTime  @default(now())

  // Relationships
  debtPlan DebtPlan @relation(fields: [debtPlanId], references: [id], onDelete: Cascade)
  loan     Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([debtPlanId])
  @@index([loanId])
  @@map("debt_plan_loans")
}

// =============================================================================
// PHASE 3: INVESTMENT ENUMS
// =============================================================================

enum InvestmentAccountType {
  BROKERAGE
  SUPERS
  FUND
  TRUST
  ETF_CRYPTO
}

enum HoldingType {
  SHARE
  ETF
  MANAGED_FUND
  CRYPTO
}

enum InvestmentTransactionType {
  BUY
  SELL
  DIVIDEND
  DISTRIBUTION
  DRP
}

enum DepreciationCategory {
  DIV40
  DIV43
}

enum DepreciationMethod {
  PRIME_COST
  DIMINISHING_VALUE
}

// =============================================================================
// PHASE 3: INVESTMENT ACCOUNT
// =============================================================================

model InvestmentAccount {
  id           String                @id @default(uuid())
  userId       String
  name         String
  type         InvestmentAccountType
  platform     String?               // e.g. CommSec, SelfWealth, Betashares app
  currency     String                @default("AUD")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  // Relationships
  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings     InvestmentHolding[]
  transactions InvestmentTransaction[]
  incomes      Income[]
  expenses     Expense[]

  @@index([userId])
  @@map("investment_accounts")
}

// =============================================================================
// PHASE 3: INVESTMENT HOLDING
// =============================================================================

model InvestmentHolding {
  id                  String            @id @default(uuid())
  investmentAccountId String
  ticker              String            // VAS, A200, VGS, BHP
  units               Float
  averagePrice        Float
  frankingPercentage  Float?            // AU feature for franking credits
  type                HoldingType
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relationships
  investmentAccount   InvestmentAccount       @relation(fields: [investmentAccountId], references: [id], onDelete: Cascade)
  transactions        InvestmentTransaction[]

  @@index([investmentAccountId])
  @@map("investment_holdings")
}

// =============================================================================
// PHASE 3: INVESTMENT TRANSACTION
// =============================================================================

model InvestmentTransaction {
  id                  String                    @id @default(uuid())
  investmentAccountId String
  holdingId           String?
  date                DateTime
  type                InvestmentTransactionType
  price               Float
  units               Float
  fees                Float?
  notes               String?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt

  // Relationships
  investmentAccount   InvestmentAccount   @relation(fields: [investmentAccountId], references: [id], onDelete: Cascade)
  holding             InvestmentHolding?  @relation(fields: [holdingId], references: [id], onDelete: SetNull)

  @@index([investmentAccountId])
  @@index([holdingId])
  @@map("investment_transactions")
}

// =============================================================================
// PHASE 3: DEPRECIATION SCHEDULE
// =============================================================================

model DepreciationSchedule {
  id         String               @id @default(uuid())
  propertyId String
  category   DepreciationCategory
  assetName  String
  cost       Float
  startDate  DateTime
  rate       Float                // 2.5% for Div43, or effective life rate
  method     DepreciationMethod   // PRIME_COST | DIMINISHING_VALUE
  notes      String?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  // Relationships
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("depreciation_schedules")
}
